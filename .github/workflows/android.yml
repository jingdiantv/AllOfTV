name: Release

on:
  create:
    tags:
      - v*

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set Env
        run: |
          echo "runNumber=$GITHUB_RUN_NUMBER" >> $GITHUB_ENV
          echo "tagName=`echo $(git describe --tags --abbrev=0)`" >> $GITHUB_ENV
          echo "previousTagName=`echo $(git --no-pager tag --sort=creatordate --merged ${{ github.ref_name }} | tail -2 | head -1)`" >> $GITHUB_ENV

      - name: Update CHANGELOG
        id: changelog
        uses: requarks/changelog-action@v1
        with:
          token: ${{ github.token }}
          fromTag: ${{ env.tagName }}
          toTag: ${{ env.previousTagName }}
          writeToFile: false

      - name: Resolve Version
        run: |
          sed -i "s/code: [0-9]+$/code: ${{ env.runNumber }}/g" config.gradle
          sed -i "s/name: v[0-9\\.]+$/name: ${{ env.tagName }}/g" config.gradle

      - name: set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build with Gradle
        run: ./gradlew build

      - name: Release with Gradle
        run: ./gradlew assembleRelease

      - name: Create Github Release
        uses: ncipollo/release-action@v1.12.0
        with:
          allowUpdates: true
          draft: true
          makeLatest: true
          name: ${{ env.tagName }}
          body: ${{ steps.changelog.outputs.changes }}
          artifacts: app/build/outputs/apk/release/全剧得_*.apk
          token: ${{ secrets.GITHUB_TOKEN }}

      - uses: actions/checkout@v1
        id: cache
        with:
          path: ~/local/rubies
          key: ruby-2.6.5
          clean: false

      - name: install fir.im
        run: sudo gem install fir-cli

      - name: Upload to Fir.im
        run: |
          fir login ${{ secrets.FIR_TOKEN }}
          fir publish app/build/outputs/apk/release/全剧得_*.apk -c ${{ steps.changelog.outputs.changes }}
